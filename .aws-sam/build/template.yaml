AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'fromagerie-virtuelle-api

  Sample SAM Template for fromagerie-virtuelle-api

  '
Globals:
  Function:
    Timeout: 3
Resources:
  ComputeScoreJob:
    Type: AWS::Glue::Job
    Properties:
      Role:
        Ref: MyGlueJobRole
      Command:
        Name: glueetl
        ScriptLocation:
          Fn::Join:
          - ''
          - - s3://
            - Fn::ImportValue: fromagerie-virtuelle-S3Bucket
            - /scripts/Runner.scala
      DefaultArguments:
        --DYNAMO_TABLE:
          Fn::ImportValue: fromagerie-virtuelle-DynamoDBName
        --OUTPUT_FILE:
          Fn::Join:
          - ''
          - - s3://
            - Fn::ImportValue: fromagerie-virtuelle-S3Bucket
            - /data/output
        --COMMAND_FILE:
          Fn::Join:
          - ''
          - - s3://
            - Fn::ImportValue: fromagerie-virtuelle-S3Bucket
            - /data/commands
        --PLAYER_SUBMISSION_FILE:
          Fn::Join:
          - ''
          - - s3://
            - Fn::ImportValue: fromagerie-virtuelle-S3Bucket
            - /data/answers
        --extra-jars:
          Fn::Join:
          - ''
          - - s3://
            - Fn::ImportValue: fromagerie-virtuelle-S3Bucket
            - /jars/compute-score.jar
        --job-language: scala
        --class: fr.hymaia.fromagerie.Runner
      ExecutionProperty:
        MaxConcurrentRuns: 10
      Name:
        Fn::Sub: ${AWS::StackName}-compute-score
      WorkerType: Standard
      NumberOfWorkers: 2
      GlueVersion: 4.0
  MyGlueJobRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - glue.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: MyGlueJobPolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:*
            Resource: '*'
          - Effect: Allow
            Action:
            - dynamodb:*
            Resource:
            - Fn::ImportValue: fromagerie-virtuelle-DynamoDBArn
            - Fn::Join:
              - /
              - - Fn::ImportValue: fromagerie-virtuelle-DynamoDBArn
                - '*'
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource: '*'
          - Effect: Allow
            Action:
            - s3:*
            Resource: '*'
